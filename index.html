<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Plan Generator 6.2 - Aurora Edition</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --color-bg: #010411;
            --color-surface: #0a0e27;
            --color-glass: rgba(10, 14, 39, 0.5);
            --color-border: rgba(67, 79, 128, 0.3);
            --color-text-primary: #f0f4ff;
            --color-text-secondary: #a8b2d1;
            --color-glow-1: #00f2fe;
            --color-glow-2: #4338ca;
            --color-glow-3: #7e22ce;
            --color-accent-gradient: linear-gradient(90deg, var(--color-glow-1), var(--color-glow-2), var(--color-glow-3));
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            background-image: radial-gradient(circle at 1% 1%, #1f2937 0%, var(--color-bg) 25%);
            color: var(--color-text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Loading Screen --- */
        #loading-screen {
            position: fixed; inset: 0; background-color: var(--color-bg); z-index: 9999;
            display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease-out;
        }
        #loading-screen img { animation: pulse-glow 2.5s infinite ease-in-out; }
        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 8px var(--color-glow-1)) drop-shadow(0 0 16px var(--color-glow-2)); opacity: 0.8; }
            50% { filter: drop-shadow(0 0 16px var(--color-glow-1)) drop-shadow(0 0 32px var(--color-glow-2)); opacity: 1; }
        }

        /* --- Particle Background --- */
        #particles-js { position: fixed; width: 100vw; height: 100vh; top: 0; left: 0; z-index: -1; }
        
        /* --- Glassmorphism Panels --- */
        .glass-pane {
            background: var(--color-glass);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--color-border);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: all 0.3s ease;
        }

        .main-container { position: relative; z-index: 1; min-height: 100vh; width: 100%; }
        .scrollable-content { height: 100%; overflow-y: auto; }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: transparent; }
        .scrollable-content::-webkit-scrollbar-thumb { background-color: rgba(67, 79, 128, 0.5); border-radius: 10px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background-color: rgba(99, 110, 158, 0.7); }

        /* --- Custom Inputs & Selects --- */
        .form-label { @apply block mb-1.5 text-sm font-medium text-slate-400; }
        .form-input { 
             @apply w-full bg-slate-900/70 border-2 border-slate-700/80 text-slate-200 text-sm rounded-lg
                   placeholder-slate-500 shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)] px-3 py-[9px]
                   focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-600 focus:bg-slate-900 transition-all duration-200;
        }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.6) brightness(1.5); cursor: pointer; }

        .editable-div {
            @apply w-full bg-slate-900/70 border-2 border-slate-700/80 text-slate-200 text-sm rounded-lg 
                   shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)] px-3 py-2.5 min-h-[44px] cursor-text
                   focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-600 focus:bg-slate-900 transition-all duration-200;
        }
        .editable-div:empty::before { content: attr(data-placeholder); color: #64748b; pointer-events: none; }
        
        .selection-button {
            @apply w-full bg-slate-900/70 border-2 border-slate-700/80 text-slate-200 text-sm rounded-lg 
                   shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)] px-3 py-2.5 min-h-[44px] cursor-pointer
                   focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-600 focus:bg-slate-900 transition-all duration-200
                   flex items-center justify-between text-left;
        }
        .selection-button.add-stage-btn { @apply btn btn-primary flex-1 sm:flex-none justify-center; }
        .selection-button:not(.add-stage-btn)::after { content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; @apply text-slate-500; }
        
        /* --- Stage-Specific Input Styling --- */
        .stage-title-input {
            @apply font-bold text-white text-lg bg-transparent border-0 p-1 -ml-1 rounded hover:bg-slate-700/50 focus:bg-slate-700/80 focus:ring-1 focus:ring-sky-500 w-full;
        }
        .stage-time-input.is-warning { @apply text-yellow-400 font-bold; }


        /* --- Glowing Buttons --- */
        .btn {
            @apply px-5 py-2.5 rounded-lg font-semibold text-sm transition-all duration-300 ease-in-out
                   flex items-center justify-center gap-2 border-2 border-transparent
                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-950;
        }
        .btn-primary { @apply bg-sky-600 text-white hover:bg-sky-500 focus:ring-sky-500 shadow-[0_0_15px_rgba(56,189,248,0.3)]; }
        .btn-primary:hover { @apply shadow-[0_0_25px_rgba(56,189,248,0.5)]; }
        .btn-ai {
            color: white; border: 2px solid transparent;
            background-image: linear-gradient(var(--color-surface), var(--color-surface)), var(--color-accent-gradient);
            background-origin: border-box; background-clip: padding-box, border-box;
            box-shadow: 0 0 20px rgba(126, 34, 206, 0.4);
        }
        .btn-ai:hover { box-shadow: 0 0 30px rgba(126, 34, 206, 0.7); background-image: linear-gradient(rgba(255,255,255,0.05), rgba(255,255,255,0.05)), var(--color-accent-gradient); }
        .btn-danger { @apply bg-red-600 text-white hover:bg-red-500 focus:ring-red-500 shadow-[0_0_15px_rgba(220,38,38,0.3)]; }

        /* --- Drag and Drop --- */
        .sortable-ghost { opacity: 0.4; background: #334155; border-radius: 1.5rem; }
        .drag-handle { cursor: grab; }
        
        /* --- Modal Styling --- */
        .modal {
            position: fixed; inset: 0; z-index: 1000; display: none; align-items: center; justify-content: center;
            padding: 1rem; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        .modal-content { opacity: 0; transform: scale(0.95); transition: opacity 0.3s ease, transform 0.3s ease; width: 100%; }
        .modal.active { display: flex; }
        .modal.active .modal-content { opacity: 1; transform: scale(1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .option-button {
             @apply w-full text-center p-4 bg-slate-800/60 hover:bg-indigo-600/80 rounded-lg transition-all duration-300 border-2 border-slate-700
                    focus:outline-none focus:ring-2 focus:ring-sky-400 ease-in-out;
        }
        .option-button:hover { @apply shadow-[0_0_15px_rgba(99,102,241,0.5)]; }
        .option-button.is-selected {
            @apply bg-indigo-600 ring-2 ring-sky-400 shadow-[0_0_20px_rgba(56,189,248,0.5)];
        }

    </style>
</head>
<body class="antialiased">

    <!-- Loading Screen -->
    <div id="loading-screen">
        <img src="https://i.ibb.co/MkDD3dxc/passaporte-logotipo.png" alt="Loading Logo" class="h-32">
    </div>

    <!-- Particle Background -->
    <div id="particles-js"></div>
    
    <!-- Main Application Layout -->
    <div class="main-container flex flex-col lg:flex-row p-4 gap-6">

        <!-- Left Sidebar (Controls) -->
        <aside class="glass-pane lg:w-1/3 xl:w-1/4 flex flex-col lg:sticky top-4 lg:max-h-[calc(100vh-2rem)]">
            <div class="scrollable-content p-4 sm:p-6 flex flex-col">
                <div class="flex-grow">
                    <!-- Header -->
                    <div class="text-center">
                        <img src="https://i.ibb.co/MkDD3dxc/passaporte-logotipo.png" alt="Passaporte Edu Logo" class="mx-auto mb-4 h-24" >
                        <h1 class="text-2xl font-bold text-white">Lesson Plan Generator</h1>
                        <p class="text-sm text-slate-400">v6.2 - Aurora Edition</p>
                    </div>
                    
                    <div id="message-area" class="h-14"></div>

                    <!-- Main Info Form -->
                    <div class="space-y-4">
                        <h2 class="text-lg font-semibold text-white border-b border-slate-700 pb-2">Lesson Details</h2>
                        <div>
                            <label class="form-label">Teacher</label>
                            <div id="teacher" contenteditable="true" class="editable-div" data-placeholder="Enter teacher's name"></div>
                        </div>
                        <div>
                            <label class="form-label">Date</label>
                            <input type="date" id="date" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Class</label>
                            <div id="class" contenteditable="true" class="editable-div" data-placeholder="E.g. Teens 10"></div>
                        </div>
                        <div>
                            <label class="form-label">Lesson Topic</label>
                            <div id="lessonTopic" contenteditable="true" class="editable-div" data-placeholder="e.g., Simple Present with He/She/It"></div>
                        </div>
                        <div>
                            <label class="form-label">Aim of the Lesson</label>
                            <div id="lessonAim" contenteditable="true" class="editable-div" data-placeholder="The AI will generate this..."></div>
                        </div>
                         <div>
                            <label class="form-label">Student Interests (Optional)</label>
                            <div id="studentInterests" contenteditable="true" class="editable-div" data-placeholder="e.g., games, music, travel"></div>
                        </div>
                    </div>

                    <!-- Actions Section -->
                    <div class="space-y-3 pt-4">
                        <button id="generateWithAI" class="btn btn-ai w-full text-base">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            <span id="ai-button-text">Generate with AI</span>
                        </button>
                         <div class="grid grid-cols-2 gap-3">
                            <button id="applyTemplateBtn" class="btn bg-slate-700 text-slate-200 hover:bg-slate-600 focus:ring-slate-500"><i class="fa-solid fa-file-alt"></i> 150min Template</button>
                            <button id="downloadPdf" class="btn btn-primary"><i class="fa-solid fa-file-pdf"></i> Download PDF</button>
                         </div>
                    </div>

                    <!-- Backup Section -->
                     <div class="space-y-3 pt-4">
                        <h2 class="text-lg font-semibold text-white border-b border-slate-700 pb-2">Backup & Restore</h2>
                         <div class="grid grid-cols-2 gap-3">
                            <button id="backupToFile" class="btn bg-emerald-600 text-white hover:bg-emerald-500 focus:ring-emerald-500"><i class="fa-solid fa-download"></i> Backup</button>
                            <button id="loadFromFile" class="btn bg-transparent border-2 border-slate-600 text-slate-300 hover:bg-slate-800"><i class="fa-solid fa-upload"></i> Load</button>
                        </div>
                    </div>
                </div>
                <!-- Credits Footer -->
                <footer class="text-center text-xs text-slate-500 pt-6 mt-auto">
                    <p>Developed by: Philippe Azevedo from Passaporte Edu</p>
                    <p>version 2.0 w/ AI</p>
                </footer>
            </div>
        </aside>

        <!-- Right Main Content (Lesson Plan) -->
        <main class="flex-1 flex flex-col min-w-0">
             <div class="space-y-6">
                <!-- Plan Header -->
                <div class="glass-pane flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-4 sm:p-6 lg:p-8">
                    <div>
                        <h2 class="text-3xl font-extrabold text-white">Your Lesson Plan</h2>
                        <div class="flex items-center flex-wrap gap-x-4 gap-y-1 text-slate-400 mt-2">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-layer-group"></i> <span id="stage-count">0</span> Stages</span>
                            <span class="flex items-center gap-2"><i class="fa-solid fa-clock"></i> <span id="total-time">0</span> min</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 w-full sm:w-auto">
                        <button id="clearLessonPlan" class="btn btn-danger flex-1 sm:flex-none"><i class="fa-solid fa-trash"></i> Clear</button>
                        <button class="btn btn-primary flex-1 sm:flex-none selection-button add-stage-btn" data-field="addStage" data-title="Add New Stage"><i class="fa-solid fa-plus"></i> Add Stage</button>
                    </div>
                </div>
                
                <!-- Additional Information Section -->
                <div class="glass-pane p-4 sm:p-6 lg:p-8">
                    <h3 class="text-xl font-semibold text-white mb-4">Additional Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="form-label">Class Type</label>
                                <button id="classTypeBtn" class="selection-button" data-field="classType" data-title="Select Class Type"></button>
                            </div>
                            <div>
                                <label class="form-label">No. of Students</label>
                                <div id="numStudents" contenteditable="true" class="editable-div" data-placeholder="e.g., 12"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                             <div>
                                <label class="form-label">Course</label>
                                <button id="levelCourseTypeBtn" class="selection-button" data-field="levelCourseType" data-title="Select Course"></button>
                            </div>
                            <div>
                                <label class="form-label">Level/Book</label>
                                <button id="levelDetailBtn" class="selection-button" data-field="levelDetail" data-title="Select Level/Book"></button>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                             <label class="form-label">Anticipated Problems & Solutions</label>
                             <div id="possibleProblems" contenteditable="true" class="editable-div" data-placeholder="Describe potential issues and your strategies..."></div>
                        </div>
                    </div>
                </div>

                <!-- Stages Container -->
                <div id="stages-container" class="space-y-4">
                    <!-- Dynamic stages will be inserted here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modals are placed at the end of the body -->
    <div id="selectionModal" class="modal"></div>
    <div id="confirmationModal" class="modal"></div>

<script>
// Wait for the entire DOM to be loaded before initializing the app.
document.addEventListener('DOMContentLoaded', () => {

    // --- UTILITIES & CONSTANTS ---
    const debounce = (func, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    };
    
    const LOGO_URL = 'https://i.ibb.co/MkDD3dxc/passaporte-logotipo.png';

    // --- INITIAL SETUP ---
    const initParticles = () => {
        if (typeof particlesJS === 'undefined') return;
        particlesJS('particles-js', {
            "particles": { "number": { "value": 80, "density": { "enable": true, "value_area": 800 } }, "color": { "value": ["#00f2fe", "#4338ca", "#7e22ce", "#ffffff"] }, "shape": { "type": "circle" }, "opacity": { "value": 0.6, "random": true, "anim": { "enable": true, "speed": 1, "opacity_min": 0.1, "sync": false } }, "size": { "value": 2.5, "random": true, "anim": { "enable": false } }, "line_linked": { "enable": true, "distance": 150, "color": "#4338ca", "opacity": 0.2, "width": 1 }, "move": { "enable": true, "speed": 2, "direction": "none", "random": true, "straight": false, "out_mode": "out", "bounce": false } },
            "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" }, "resize": true }, "modes": { "grab": { "distance": 140, "line_linked": { "opacity": 0.5 } }, "push": { "particles_nb": 4 } } },
            "retina_detect": true
        });
    };

    const handleLoadingScreen = () => {
        const loadingScreen = document.getElementById('loading-screen');
        window.onload = () => {
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 500);
            }, 500);
        };
    };

    // --- MODULE: State Management ---
    const AppState = {
        data: {
            teacher: '', classType: 'Presentation - Grammar', lessonTopic: '', lessonAim: '', studentInterests: '',
            date: '', class: '', levelCourseType: 'KDGT', levelDetail: '', numStudents: '',
            possibleProblems: '', stages: []
        },
        loadState(newState) { 
            this.data = { ...this.data, ...newState, stages: newState.stages || [] };
            UIModule.renderAll(); 
        },
        clear() {
            this.data = {
                teacher: '', classType: 'Presentation - Grammar', lessonTopic: '', lessonAim: '', studentInterests: '',
                date: '', class: '', levelCourseType: 'KDGT', levelDetail: 'A1-', numStudents: '',
                possibleProblems: '', stages: []
            };
            UIModule.renderAll(); 
            UIModule.setDefaultDate();
        }
    };
    
    // --- MODULE: Storage ---
    const StorageModule = {
        save: debounce(() => { 
            localStorage.setItem('lessonPlanDataV6_2', JSON.stringify(AppState.data)); 
            UIModule.displayMessage('Progress saved!', 'info');
        }, 1200),
        load() {
            try {
                const savedData = localStorage.getItem('lessonPlanDataV6_2');
                if (savedData) { AppState.loadState(JSON.parse(savedData)); }
                else { UIModule.renderAll(); UIModule.setDefaultDate(); }
            } catch (e) { 
                console.error("Failed to load data from localStorage:", e);
                UIModule.displayMessage('Failed to load saved data.', 'error'); 
                AppState.clear(); 
            }
        },
        backupToFile() {
            const dataStr = JSON.stringify(AppState.data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `lesson_plan_${AppState.data.date || new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
            UIModule.displayMessage('Backup JSON file saved!', 'success');
        },
        loadFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const parsedData = JSON.parse(event.target.result);
                             UIModule.showConfirmation(
                                 'This will overwrite the current plan. Continue?',
                                 () => { 
                                     AppState.loadState(parsedData); 
                                     UIModule.displayMessage('Plan loaded from file.', 'success'); 
                                }, 'btn-primary'
                             );
                        } catch (err) { UIModule.displayMessage('Invalid or corrupted backup file.', 'error'); }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
    };
    
    // --- MODULE: UI & Interactions ---
    const UIModule = {
        elements: {},
        config: {
            classType: ["Presentation - Grammar", "Presentation - Vocabulary", "Presentation - Vocabulary/Grammar", "Consolidation", "Skills", "Review", "Written Test", "Oral Test", "Pedagogical Meeting"],
            levelCourseType: ["KDGT", "Kids", "PreTeens", "Teens", "YoungAdults", "Regular", "BilingualComputing", "Coding I", "Coding II", "Financial Intelligence", "Soft Skills", "Inter", "Spanish"],
            levelDetailOptions: {
                 standardLevels: ["A1-", "A1", "A1+", "A2-", "A2", "A2+"],
                 bilingualBooks: ["Book 1", "Book 2", "Book 3", "Book 4", "Book 5", "Book 6", "Book 7", "Book 8", "Book 9", "Book 10", "Book 11", "Book 12"],
                 interSpecificBooks: ["Book 1", "Book 2", "Cambridge"],
                 espanholLevels: ["Spanish A1-", "Spanish A1", "Spanish A1+", "Spanish A2-", "Spanish A2", "Spanish A2+"],
            },
            addStage: ["Warm Up!", "Presentation", "Practice", "Production", "Break", "Wrap Up!", "Homework", "Custom Stage"],
        },
        getTemplate(timings) {
             return [ 
                { name: "Warm Up!", timing: timings.warmUp }, 
                { name: "Presentation", timing: timings.presentation }, 
                { name: "Practice", timing: timings.practice }, 
                { name: "Practice", timing: timings.practice }, 
                { name: "Production", timing: timings.production }, 
                { name: "Break", timing: timings.break }, 
                { name: "Practice", timing: 25 }, // The one after break is longer as requested
                { name: "Production", timing: timings.production }, 
                { name: "Wrap Up!", timing: timings.wrapUp } 
            ];
        },
        cacheElements() {
            this.elements = {
                mainContainer: document.querySelector('.main-container'),
                teacher: document.getElementById('teacher'),
                lessonTopic: document.getElementById('lessonTopic'), 
                lessonAim: document.getElementById('lessonAim'),
                studentInterests: document.getElementById('studentInterests'),
                date: document.getElementById('date'),
                class: document.getElementById('class'),
                numStudents: document.getElementById('numStudents'),
                possibleProblems: document.getElementById('possibleProblems'), 
                stagesContainer: document.getElementById('stages-container'),
                messageArea: document.getElementById('message-area'), 
                stageCount: document.getElementById('stage-count'),
                totalTime: document.getElementById('total-time'),
                selectionModal: document.getElementById('selectionModal'),
                confirmationModal: document.getElementById('confirmationModal'),
            };
        },
        init() {
            this.cacheElements();
            this.renderModals();
            this.bindGlobalEvents();
            new Sortable(this.elements.stagesContainer, { 
                animation: 150, ghostClass: 'sortable-ghost', handle: '.drag-handle',
                onEnd: (evt) => {
                    const [movedItem] = AppState.data.stages.splice(evt.oldIndex, 1);
                    AppState.data.stages.splice(evt.newIndex, 0, movedItem);
                    StorageModule.save();
                }
            });
        },
        bindGlobalEvents() {
            this.elements.mainContainer.addEventListener('input', (e) => {
                const target = e.target;
                const id = target.id;
                if (target.matches('.form-input')) {
                    AppState.data[id] = target.value;
                } else if (target.matches('.editable-div')) {
                    const stageCard = target.closest('.stage-card');
                    if (stageCard) {
                        const stageId = stageCard.dataset.id;
                        const field = target.dataset.field;
                        const stage = AppState.data.stages.find(s => s.id === stageId);
                        if (stage) stage[field] = target.textContent;
                    } else {
                        AppState.data[id] = target.textContent;
                    }
                }
                StorageModule.save();
            });

            this.elements.mainContainer.addEventListener('keydown', (e) => {
                 if(e.target.matches('#numStudents, .stage-time-input')){
                    if (!((e.key >= '0' && e.key <= '9') || ['Backspace', 'ArrowLeft', 'ArrowRight', 'Delete', 'Tab'].includes(e.key))) {
                        e.preventDefault();
                    }
                 }
            });

            this.elements.mainContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button) this.handleButtonClick(button);
            });

            this.elements.mainContainer.addEventListener('paste', (e) => {
                if(e.target.matches('[contenteditable="true"]')) {
                    e.preventDefault();
                    document.execCommand('insertText', false, e.clipboardData.getData('text/plain'));
                }
            });
        },
        handleButtonClick(button) {
            const id = button.id;
            
            if (id === 'generateWithAI') AIModule.generatePlan();
            else if (id === 'downloadPdf') PDFModule.generate();
            else if (id === 'clearLessonPlan') this.showConfirmation('Clear entire plan? This cannot be undone.', () => { AppState.clear(); this.displayMessage('Plan cleared.'); });
            else if (id === 'backupToFile') StorageModule.backupToFile();
            else if (id === 'loadFromFile') StorageModule.loadFromFile();
            else if (id === 'applyTemplateBtn') {
                this.showConfirmation('Apply the 150min template? This will replace current stages.', () => {
                    const timings = { warmUp: 7, presentation: 25, practice: 15, production: 20, wrapUp: 5, break: 15 };
                    AppState.data.stages = this.getTemplate(timings).map(s => ({...s, id: crypto.randomUUID(), aim:'', activity:'', focus:'', material:''}));
                    this.renderStages(); 
                    this.displayMessage(`Template applied successfully.`, 'success');
                    StorageModule.save();
                }, 'btn-primary');
            }
            else if (button.classList.contains('selection-button')) this.openSelectionModal(button);
            else if (button.classList.contains('remove-stage')) {
                 const stageId = button.closest('.stage-card').dataset.id;
                 this.showConfirmation('Remove this stage?', () => {
                     AppState.data.stages = AppState.data.stages.filter(s => s.id !== stageId); 
                     this.renderStages();
                     StorageModule.save();
                 });
            }
        },
        renderAll() {
            const state = AppState.data;
            this.elements.teacher.textContent = state.teacher || ''; 
            this.elements.lessonTopic.textContent = state.lessonTopic || '';
            this.elements.lessonAim.textContent = state.lessonAim || '';
            this.elements.studentInterests.textContent = state.studentInterests || '';
            this.elements.class.textContent = state.class || '';
            this.elements.numStudents.textContent = state.numStudents || '';
            this.elements.possibleProblems.textContent = state.possibleProblems || '';
            this.elements.date.value = state.date || '';
            
            document.getElementById('classTypeBtn').textContent = state.classType;
            document.getElementById('levelCourseTypeBtn').textContent = state.levelCourseType;
            document.getElementById('levelDetailBtn').textContent = state.levelDetail || this.getLevelDetailOptions()[0];

            this.renderStages();
        },
        getLevelDetailOptions() {
            const selectedCourse = AppState.data.levelCourseType;
            const opts = this.config.levelDetailOptions;
            if (["BilingualComputing"].includes(selectedCourse)) return ["N/A"];
            if (["Coding I", "Coding II", "Financial Intelligence", "Soft Skills"].includes(selectedCourse)) return opts.bilingualBooks;
            if (selectedCourse === "Inter") return opts.interSpecificBooks;
            if (selectedCourse === "Spanish") return opts.espanholLevels;
            return opts.standardLevels;
        },
        renderStages() {
            this.elements.stagesContainer.innerHTML = '';
            if (!AppState.data.stages || AppState.data.stages.length === 0) {
                this.elements.stagesContainer.innerHTML = `<div class="text-center py-10 px-6 glass-pane"><i class="fa-solid fa-wand-magic-sparkles text-4xl text-slate-600 mb-3"></i><h3 class="font-semibold text-white">Your Plan is Empty</h3><p class="text-slate-400 text-sm">Use the AI or add a stage to begin.</p></div>`;
            } else { 
                AppState.data.stages.forEach(stage => this.elements.stagesContainer.appendChild(this.createStageElement(stage))); 
            }
            this.updateCounters();
        },
        createStageElement(stage) {
            const div = document.createElement('div');
            div.className = 'glass-pane stage-card';
            div.dataset.id = stage.id;
            const timeWarningClass = stage.name === 'Production' && parseInt(stage.timing) > 20 ? 'is-warning' : '';

            div.innerHTML = `
                <div class="p-4 flex gap-4">
                    <div class="drag-handle pt-2 text-lg text-slate-500 hover:text-sky-400 transition-colors cursor-grab"><i class="fas fa-grip-vertical"></i></div>
                    <div class="flex-1 space-y-3 min-w-0">
                        <div class="flex justify-between items-center gap-4 pb-3 border-b border-slate-700/50">
                            <div contenteditable="true" data-field="name" class="stage-title-input editable-div">${stage.name}</div>
                            <div class="flex items-center gap-4 flex-shrink-0">
                                <div class="flex items-center gap-1">
                                    <label class="text-xs text-slate-400">Time:</label>
                                    <div contenteditable="true" data-field="timing" class="stage-time-input editable-div px-1 py-0 min-h-0 w-12 text-center ${timeWarningClass}">${stage.timing || 0}</div>
                                    <span class="text-xs text-slate-500">min</span>
                                </div>
                                <button class="btn bg-transparent border-red-800/50 text-red-400 hover:bg-red-500/20 btn-sm py-1 px-2 remove-stage"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm pt-2">
                            <div><label class="form-label text-xs">Aim</label><div data-field="aim" class="editable-div" contenteditable="true" data-placeholder="What is the goal of this stage?">${stage.aim || ''}</div></div>
                            <div><label class="form-label text-xs">Activity/Procedure</label><div data-field="activity" class="editable-div" contenteditable="true" data-placeholder="Describe the activity...">${stage.activity || ''}</div></div>
                            <div><label class="form-label text-xs">Focus</label><div data-field="focus" class="editable-div" contenteditable="true" data-placeholder="T-S, S-S...">${stage.focus || ''}</div></div>
                            <div><label class="form-label text-xs">Material</label><div data-field="material" class="editable-div" contenteditable="true" data-placeholder="Book, whiteboard...">${stage.material || ''}</div></div>
                        </div>
                    </div>
                </div>`;
            return div;
        },
        updateCounters() {
            this.elements.stageCount.textContent = AppState.data.stages.length;
            const totalTime = AppState.data.stages.reduce((sum, stage) => sum + (parseInt(stage.timing) || 0), 0);
            this.elements.totalTime.textContent = totalTime;
        },
        displayMessage(message, type = 'success') {
            const colors = { success: 'bg-emerald-500/80', error: 'bg-red-500/80', info: 'bg-sky-500/80' };
            const icon = { success: 'fa-check-circle', error: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            this.elements.messageArea.innerHTML = `<div class="p-3 rounded-lg text-sm text-white text-center font-medium ${colors[type]} shadow-lg flex items-center justify-center gap-2 animate-fadeIn"><i class="fa-solid ${icon[type]}"></i> ${message}</div>`;
            setTimeout(() => { this.elements.messageArea.innerHTML = ''; }, 4000);
        },
        setDefaultDate() { if (!this.elements.date.value) { this.elements.date.value = new Date().toISOString().split('T')[0]; }},
        
        openModal(modal) { modal.classList.add('active'); },
        closeModal(modal) { modal.classList.remove('active'); },
        showConfirmation(message, onConfirm, confirmBtnClass = 'btn-danger') {
            const modal = this.elements.confirmationModal;
            modal.querySelector('#confirmationMessage').textContent = message;
            const confirmBtn = modal.querySelector('#confirmAction');
            confirmBtn.className = `btn ${confirmBtnClass}`;
            const newConfirmBtn = confirmBtn.cloneNode(true); 
            newConfirmBtn.textContent = "Confirm";
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => { onConfirm(); this.closeModal(modal); }, { once: true });
            this.openModal(modal);
        },
        renderModals() {
            this.elements.selectionModal.innerHTML = `
                <div class="glass-pane modal-content max-w-lg p-6">
                    <div class="flex justify-between items-center mb-6"><h3 id="selectionModalTitle" class="text-xl font-bold text-white">Select an Option</h3><button class="text-slate-400 hover:text-white text-2xl close-modal">&times;</button></div>
                    <div id="selectionModalOptions" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-96 overflow-y-auto"></div>
                </div>`;
            
            this.elements.confirmationModal.innerHTML = `
                <div class="glass-pane modal-content max-w-sm p-6 text-center">
                    <h3 class="text-lg font-bold text-white">Confirmation</h3>
                    <p id="confirmationMessage" class="text-slate-300 my-4">Are you sure?</p>
                    <div class="flex justify-center gap-3 mt-5"><button class="btn bg-slate-700 text-slate-200 hover:bg-slate-600 close-modal">Cancel</button><button id="confirmAction" class="btn btn-danger">Confirm</button></div>
                </div>`;
            document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', (e) => this.closeModal(e.target.closest('.modal'))));
        },
        openSelectionModal(button) {
            const field = button.dataset.field;
            const title = button.dataset.title;
            const options = field === 'levelDetail' ? this.getLevelDetailOptions() : this.config[field];
            const selectedValue = AppState.data[field];
            const modal = this.elements.selectionModal;
            
            modal.querySelector('#selectionModalTitle').textContent = title;
            const container = modal.querySelector('#selectionModalOptions');
            
            container.innerHTML = options.map(opt => 
                `<button class="option-button ${opt === selectedValue ? 'is-selected' : ''}" data-value="${opt}">${opt}</button>`
            ).join('');

            container.onclick = (e) => {
                const optionButton = e.target.closest('.option-button');
                if(!optionButton) return;
                const value = optionButton.dataset.value;

                if(field === 'addStage'){
                    this.addStage(value);
                } else {
                    AppState.data[field] = value;
                    if (field === 'levelCourseType') {
                        AppState.data.levelDetail = this.getLevelDetailOptions()[0];
                    }
                    this.renderAll();
                    StorageModule.save();
                }
                this.closeModal(modal);
            };

            this.openModal(modal);
        },
        addStage(name) {
            const timings = { 'Warm Up!': 7, 'Presentation': 25, 'Practice': 15, 'Production': 20, 'Wrap Up!': 5, 'Break': 15 };
            const timing = timings[name] || 10;
            AppState.data.stages.push({ id: crypto.randomUUID(), name, timing, aim: '', activity: '', focus: '', material: '' });
            this.renderStages(); 
            this.displayMessage(`Stage "${name}" added.`, 'success');
            StorageModule.save();
        }
    };
    
    // --- MODULE: AI Engine (Generative) ---
    const AIModule = {
        async generatePlan() {
            const apiKey = "AIzaSyD_wk9jgd61whdzlibIe00su-cqynWV0PA"; // Integrated API Key
            const { lessonTopic, studentInterests, classType, numStudents, levelCourseType, levelDetail, class: className } = AppState.data;
            if (!lessonTopic) { 
                UIModule.displayMessage("Please provide the 'Lesson Topic' for the AI.", "error"); 
                return; 
            }
            
            const aiButton = document.getElementById('generateWithAI');
            const originalButtonHtml = aiButton.innerHTML;
            aiButton.disabled = true;
            aiButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Generating...`;
            UIModule.displayMessage("Researching and crafting your lesson plan...", "info");

            const prompt = `
                Create a creative and unique 150-minute lesson plan based on the PPP (Presentation, Practice, Production) methodology.
                The plan is for the following context:
                - Lesson Topic: "${lessonTopic}"
                - Class Type: "${classType}"
                - Class Name: "${className}"
                - Number of Students: ${numStudents || 'a small group'}
                - Course: ${levelCourseType}
                - Level/Book: ${levelDetail}
                - Student Interests: ${studentInterests || 'not specified'}

                Generate a single JSON object with two properties: "lessonAim" (a string) and "stages" (an array of 9 stage objects).
                The "lessonAim" should be a concise purpose for the entire lesson.
                Each object in the "stages" array must have "name", "timing", "aim", "activity", "focus", and "material" properties.
                The "activity" description MUST be in the third person (e.g., "The teacher will show..."). 
                Production activities should be student-centered, with the teacher acting as a facilitator.
                For the "focus" property, use only standard interaction patterns like "T-S" (Teacher-to-Student), "S-S" (Student-to-Student), or "S-T" (Student-to-Teacher).
                
                The total time must be exactly 150 minutes, following this specific structure and STRICT timings:
                - Warm Up: 7 minutes
                - Presentation: 25 minutes
                - Practice 1: 15 minutes
                - Practice 2: 15 minutes
                - Production 1: 20 minutes
                - Break: 15 minutes
                - Practice 3: 25 minutes
                - Production 2: 20 minutes
                - Wrap Up: 8 minutes
                
                Ensure "Practice" stages do not exceed their allotted time. The third practice can be longer.
                Ensure "Production" stages do not exceed 20 minutes.
                Create unique and engaging activities for each stage that are highly specific to the provided context. Do not use generic placeholders.
            `;
            
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "lessonAim": { "type": "STRING" },
                                "stages": {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "name": { "type": "STRING" },
                                            "timing": { "type": "INTEGER" },
                                            "aim": { "type": "STRING" },
                                            "activity": { "type": "STRING" },
                                            "focus": { "type": "STRING" },
                                            "material": { "type": "STRING" },
                                        },
                                        required: ["name", "timing", "aim", "activity", "focus", "material"]
                                    }
                                }
                            },
                            required: ["lessonAim", "stages"]
                        }
                    }
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    throw new Error(`API request failed with status ${response.status}: ${errorData.error.message}`);
                }
                
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const generatedData = JSON.parse(result.candidates[0].content.parts[0].text);
                    AppState.data.lessonAim = generatedData.lessonAim;
                    AppState.data.stages = generatedData.stages.map(s => ({ ...s, id: crypto.randomUUID() }));
                    UIModule.renderAll();
                    UIModule.displayMessage('AI has successfully generated your lesson plan!', 'success');
                } else {
                    throw new Error("Invalid response structure from AI.");
                }
            } catch (error) {
                console.error("AI Generation Error:", error);
                UIModule.displayMessage('AI generation failed. Please try again.', 'error');
            } finally {
                aiButton.disabled = false;
                aiButton.innerHTML = originalButtonHtml;
            }
        }
    };

    // --- MODULE: PDF Generation ---
    const PDFModule = {
        loadImageAsBase64(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                };
                img.onerror = (e) => {
                    console.error("Image load error:", e);
                    reject(new Error('Failed to load image for PDF'));
                };
                img.src = url;
            });
        },
        async generate() {
            UIModule.displayMessage('Generating PDF...', 'info');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            const state = AppState.data;
            try {
                const logoData = await this.loadImageAsBase64(LOGO_URL);
                doc.addImage(logoData, 'PNG', 15, 12, 50, 25);
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(30, 30, 30);
                doc.text('LESSON PLAN', 148, 25, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');

                const col1X = 15;
                const col2X = 148;
                let currentY = 40;

                doc.text(`Teacher: ${state.teacher || 'N/A'}`, col1X, currentY);
                doc.text(`Date: ${state.date || 'N/A'}`, col2X, currentY);
                currentY += 6;
                doc.text(`Class type: ${state.classType || 'N/A'}`, col1X, currentY);
                doc.text(`Class: ${state.class || 'N/A'}`, col2X, currentY);
                currentY += 6;
                doc.text(`Level: ${state.levelCourseType || 'N/A'} - ${state.levelDetail || 'N/A'}`, col1X, currentY);
                doc.text(`Number of students: ${state.numStudents || 'N/A'}`, col2X, currentY);
                currentY += 6;
                const aimText = `Aim of the Lesson: ${state.lessonAim || state.lessonTopic || 'N/A'}`;
                doc.text(doc.splitTextToSize(aimText, 260), col1X, currentY);
                currentY += 10;
                const objectiveText = `Objective: At the end of the class, students should be able to effectively talk about ${state.lessonTopic || 'the lesson topic'}.`;
                doc.text(doc.splitTextToSize(objectiveText, 260), col1X, currentY);
                currentY += 10;
                doc.text(doc.splitTextToSize(`Antecipated problems and solutions: ${state.possibleProblems || 'N/A'}`, 260), col1X, currentY);

                const head = [['STAGE', 'AIM', 'ACTIVITY/PROCEDURE', 'FOCUS', 'MATERIAL', 'TIMING']];
                const body = state.stages.map(stage => [
                    stage.name || '',
                    stage.aim || '',
                    stage.activity || '',
                    stage.focus || '',
                    stage.material || '',
                    `${stage.timing || '0'}'`
                ]);

                doc.autoTable({
                    head: head,
                    body: body,
                    startY: currentY + 10,
                    theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                    styles: { cellPadding: 2, fontSize: 9, valign: 'middle' },
                    columnStyles: {
                        0: { cellWidth: 35 },
                        1: { cellWidth: 50 },
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 30 },
                        4: { cellWidth: 30 },
                        5: { cellWidth: 15, halign: 'center' }
                    }
                });
                
                doc.save(`Lesson_Plan_${state.teacher || 'User'}_${state.date}.pdf`);
                UIModule.displayMessage('PDF downloaded successfully!', 'success');
            } catch (error) {
                console.error("PDF Generation Error:", error);
                UIModule.displayMessage('Failed to generate PDF.', 'error');
            }
        }
    };

    // --- APPLICATION INITIALIZATION ---
    handleLoadingScreen();
    initParticles();
    UIModule.init();
    StorageModule.load();
    
});
</script>
</body>
</html>
